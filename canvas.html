<html>
    <head>

    </head>
    <body>
        <canvas id="canvas" tabindex="1" width="80%" height="900"></canvas>

        <!--<p id="downlog">Down</p>
        <p id="movelog">Move</p>
        <p id="uplog">Up</p>
        <p id="outlog">Out</p>-->

        <script type="text/javascript" language="javascript">
            var canvas = document.getElementById("canvas");
            canvas.addEventListener('click', function(e) { handleClick(e) });
            canvas.addEventListener('keydown', function(e) { handleKeyDown(e) });
            canvas.addEventListener('keyup', function(e) { handleKeyUp(e) });
            canvas.addEventListener('mousedown', function(e) { handleMouseDown(e) });
            canvas.addEventListener('mouseup', function(e) { handleMouseUp(e) });
            canvas.addEventListener('mousemove', function(e) { handleMouseMove(e) });

            var context = canvas.getContext("2d");
            
            var margin = 5;
            var separation = 10;
            var border = 5;
            var width = 140;
            var heigth = 120;

            var rhythm = 1;
            var pulses = 4 * rhythm;
            var measures = 3;
            var frequencies = 7;

            var map = [];

            var isBackspacePressed = false;
            var isDeletePressed = false;
            var isCtrlPressed = false;

            var widthPerPulse = border + width;
            var heightPerPulse = border + heigth;
            var widthPerMeasure = (width * pulses) + (border * (pulses + 1))
            var heigthPerMeasure = (heigth * frequencies) + (border * (frequencies + 1));

            canvas.width  = margin * 2 + (widthPerMeasure * measures) + (margin * measures) - margin;
            canvas.height = margin * 2 + heigthPerMeasure;

            // var canvasOffset=$("#canvas").offset();
            // var offsetX=canvasOffset.left;
            // var offsetY=canvasOffset.top;

            // selecionar
            // selecionados
            // remover a seleção
            
            function getMap() {
                var widthSeparation = 0;
                var widthPulse = 0;
                var heightPulse = 0;
                
                if (map.length == 0) {
                    for(var i = 0; i <= measures - 1; i++) {
                        heightPulse = 0;

                        var aux = 0;

                        for(var x = 0; x <= frequencies - 1; x++) {
                            var yOfPulsesPixel = margin + border + heightPulse;

                            for(var y = 0; y <= pulses - 1; y++) {
                                var xOfPulsesPixel = margin + border + widthPulse + widthSeparation;
                                
                                widthPulse += border + width;
                                
                                map.push([xOfPulsesPixel, yOfPulsesPixel, width, heigth]);
                            }

                            widthPulse = 0;

                            heightPulse += border + heigth;
                        }
                        
                        widthSeparation += widthPerMeasure + margin;
                    }
                }

                return map;
            }

            function getIndex(x, y) {
                var i = 0;
            }

            function measure(x, y) {
                context.moveTo(x, y);

                // axis x
                for(i = 0; i <= frequencies; i++) {
                    var line = i == 0 ? 0 : border;

                    for (z = 0; z <= border; z++) {
                        context.moveTo(x, y + (heigth + line) * i + z);
                        context.lineTo(x + (width * pulses) + (border * (pulses + 1)), y + (heigth + line) * i + z);
                    }
                }

                // axis y
                for(i = 0; i <= pulses; i++) {
                    var line = i == 0 ? 0 : border;

                    for (z = 0; z <= border; z++) {
                        context.moveTo(x + (width + line) * i + z, y);
                        context.lineTo(x + (width + line) * i + z, y + (heigth * frequencies) + (border * (frequencies + 1)));
                    }
                }                
            }

            function draw() {
                context.beginPath();

                for (var w = 0; w <= measures - 1; w++) {
                    var x = w == 0 ? margin : (margin * w) + (margin + widthPerMeasure * w);

                    measure(x, margin);
                }

                context.closePath();
                context.strokeStyle = '#FFFFFF';
                context.stroke();

                map = getMap();

                map.forEach(function(i, x, a) {
                    context.fillStyle = '#EEEEEE';
                    context.fillRect(i[0], i[1], i[2], i[3]);
                });
            }

            function handleClick(e) {
                var i = 1;
                //http://stackoverflow.com/questions/17130395/real-mouse-position-in-canvas
                //context.fillRect(x, y, w, h);
            }

            function handleKeyDown(e) {
                // verificar se é o SHIFT, se for fazer unbind do click
                // abrir a selação de multiplas celulas
                // http://stackoverflow.com/questions/12886286/addeventlistener-for-keydown-on-canvas
                // verificar se é DEL ou BACKSPACE e remover a seleção
                // verificar se são setas e movimentar a selação
            }

            function handleKeyUp(e) {
                // voltar evento do click  
                var i = 1;
            }

            function handleMouseDown(e) {
                // mouseX=parseInt(e.clientX-offsetX);
                // mouseY=parseInt(e.clientY-offsetY);
                // $("#downlog").html("Down: "+ mouseX + " / " + mouseY);

                // // Put your mousedown stuff here
            }

            function handleMouseUp(e) {
                // mouseX=parseInt(e.clientX-offsetX);
                // mouseY=parseInt(e.clientY-offsetY);
                // $("#uplog").html("Up: "+ mouseX + " / " + mouseY);

                // // Put your mouseup stuff here
            }

            function handleMouseMove(e) {
                // http://stackoverflow.com/questions/19132064/transparency-context-fill-style-in-canvas-html5

                // mouseX=parseInt(e.clientX-offsetX);
                // mouseY=parseInt(e.clientY-offsetY);
                // $("#movelog").html("Move: "+ mouseX + " / " + mouseY);

                // // Put your mousemove stuff here
                //context.fillStyle = 'rgba(157, 0, 0, 0.5)';
            }
            
            draw();
    </script>
    </body>
</html>
